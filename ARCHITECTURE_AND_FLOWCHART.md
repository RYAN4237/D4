# ç³»ç»Ÿæ¶æ„å’Œæµç¨‹å›¾

## ğŸ—ï¸ æ•´ä½“æ¶æ„

```
SmartMinimapStitcher
â”œâ”€â”€ åˆå§‹åŒ–ç»„ä»¶
â”‚   â”œâ”€â”€ ç”»å¸ƒç®¡ç† (canvas, canvas_x, canvas_y)
â”‚   â”œâ”€â”€ å†å²è®°å½• (mean_diff_history, movement_history)
â”‚   â”œâ”€â”€ çŠ¶æ€æœº (state, state_confidence, no_move_frames)
â”‚   â”œâ”€â”€ Kalmanæ»¤æ³¢ (smooth_dx, smooth_dy, smooth_response)
â”‚   â””â”€â”€ ç‰¹å¾æ£€æµ‹ (orb, bf_matcher)
â”‚
â”œâ”€â”€ ä¸»å¾ªç¯ run()
â”‚   â”œâ”€â”€ æˆªå–æ–°å¸§ capture_minimap()
â”‚   â”œâ”€â”€ æ£€æµ‹ç§»åŠ¨ detect_movement() â† æ ¸å¿ƒæ£€æµ‹é€»è¾‘
â”‚   â”‚   â”œâ”€ ç¬¬ä¸€å±‚ï¼šè®¡ç®—mean_diff + å†å²è®°å½•
â”‚   â”‚   â”œâ”€ ç¬¬äºŒå±‚ï¼šè®¡ç®—è‡ªé€‚åº”é˜ˆå€¼
â”‚   â”‚   â”œâ”€ ç¬¬ä¸‰å±‚ï¼šç›¸ä½ç›¸å…³æ£€æµ‹
â”‚   â”‚   â”œâ”€ ç¬¬å››å±‚ï¼šKalmanæ»¤æ³¢å¹³æ»‘
â”‚   â”‚   â”œâ”€ ç¬¬äº”å±‚ï¼šå¤šæ¡ä»¶ANDéªŒè¯
â”‚   â”‚   â””â”€ ç¬¬å…­å±‚ï¼šçŠ¶æ€æœºè½¬ç§»
â”‚   â”‚
â”‚   â””â”€ if has_moved:
â”‚       â””â”€â”€ æ‹¼æ¥å¤„ç† stitch() â† æ ¸å¿ƒæ‹¼æ¥é€»è¾‘
â”‚           â”œâ”€ if confidence > 0.85: å¢é‡æ‹¼æ¥
â”‚           â”‚  â”œâ”€â”€ æå–æ–°å¢åŒºåŸŸ
â”‚           â”‚  â””â”€â”€ æ¸å˜èåˆ _blend_region()
â”‚           â””â”€ else: ç‰¹å¾åŒ¹é…å¯¹é½
â”‚              â”œâ”€â”€ ORBç‰¹å¾æ£€æµ‹
â”‚              â”œâ”€â”€ ç‰¹å¾åŒ¹é…
â”‚              â”œâ”€â”€ RANSACä¼°è®¡
â”‚              â””â”€â”€ æ ¡æ­£æ‹¼æ¥ _simple_stitch()
â”‚
â””â”€â”€ è¾…åŠ©æ–¹æ³•
    â”œâ”€â”€ _get_response_threshold() - çŠ¶æ€ç›¸å…³é˜ˆå€¼
    â”œâ”€â”€ _blend_region() - æ¸å˜èåˆ
    â””â”€â”€ _simple_stitch() - é€šç”¨æ‹¼æ¥
```

---

## ğŸ“Š detect_movement() è¯¦ç»†æµç¨‹

```
è¾“å…¥: frame_prev, frame_curr
â”‚
â”œâ”€ [ç¬¬ä¸€å±‚] åŸºç¡€è®¡ç®—
â”‚  â”œâ”€ gray1 = cvtColor(frame_prev, BGR2GRAY)
â”‚  â”œâ”€ gray2 = cvtColor(frame_curr, BGR2GRAY)
â”‚  â”œâ”€ diff = absdiff(gray1, gray2)
â”‚  â”œâ”€ mean_diff = mean(diff)
â”‚  â””â”€ mean_diff_history.append(mean_diff)  â† è®°å½•å†å²
â”‚
â”œâ”€ [ç¬¬äºŒå±‚] è‡ªé€‚åº”é˜ˆå€¼è®¡ç®—
â”‚  â”œâ”€ if len(history) >= 10:
â”‚  â”‚  â”œâ”€ baseline = mean(last_30_frames)
â”‚  â”‚  â”œâ”€ std_dev = std(last_30_frames)
â”‚  â”‚  â”œâ”€ if state == "IDLE":
â”‚  â”‚  â”‚  â””â”€ threshold = baseline + 1.5 * std_dev  [ä¸¥æ ¼]
â”‚  â”‚  â”œâ”€ elif state == "MOVING":
â”‚  â”‚  â”‚  â””â”€ threshold = baseline + 0.8 * std_dev  [å®½æ¾]
â”‚  â”‚  â””â”€ elif state == "STOPPED":
â”‚  â”‚     â””â”€ threshold = baseline + 1.2 * std_dev  [ä¸­ç­‰]
â”‚  â”‚
â”‚  â””â”€ else:
â”‚     â””â”€ threshold = fixed_value (3.0)
â”‚
â”œâ”€ [å¿«é€Ÿæ£€æŸ¥] æç«¯æƒ…å†µ
â”‚  â”œâ”€ if mean_diff < threshold * 0.5:
â”‚  â”‚  â”œâ”€ no_move_frames++
â”‚  â”‚  â””â”€ return (False, 0, 0, 0, state)
â”‚  â”‚
â”‚  â””â”€ else: ç»§ç»­å¤„ç†
â”‚
â”œâ”€ [ç¬¬ä¸‰å±‚] ç›¸ä½ç›¸å…³æ£€æµ‹
â”‚  â”œâ”€ shift, response = phaseCorrelate(gray1, gray2)
â”‚  â”œâ”€ dx, dy = shift[0], shift[1]  [åŸå§‹ä½ç§»]
â”‚  â””â”€ exception: return (False, 0, 0, 0, state)
â”‚
â”œâ”€ [ç¬¬å››å±‚] Kalmanæ»¤æ³¢å¹³æ»‘
â”‚  â”œâ”€ smooth_dx = 0.7 * prev_dx + 0.3 * dx
â”‚  â”œâ”€ smooth_dy = 0.7 * prev_dy + 0.3 * dy
â”‚  â”œâ”€ smooth_response = 0.6 * prev_response + 0.4 * response
â”‚  â””â”€ [ç»“æœ] æ¶ˆé™¤0.5åƒç´ æŠ–åŠ¨ï¼Œä¿ç•™è¶‹åŠ¿
â”‚
â”œâ”€ [ç¬¬äº”å±‚] å¤šæ¡ä»¶ANDéªŒè¯
â”‚  â”œâ”€ condition1: mean_diff > adaptive_threshold
â”‚  â”œâ”€ condition2: abs(smooth_dx) >= 0.5 OR abs(smooth_dy) >= 0.5
â”‚  â”œâ”€ condition3: smooth_response > _get_response_threshold()
â”‚  â”œâ”€ condition4: abs(dx) <= 100 AND abs(dy) <= 100  [è¿‡æ»¤å¼‚å¸¸]
â”‚  â”‚
â”‚  â””â”€ has_moved = ALL(conditions)  [å…¨éƒ¨æ»¡è¶³æ‰è®¤å®š]
â”‚
â”œâ”€ [ç¬¬å…­å±‚] çŠ¶æ€æœºè½¬ç§»
â”‚  â”œâ”€ if has_moved:
â”‚  â”‚  â”œâ”€ if state == "IDLE":
â”‚  â”‚  â”‚  â”œâ”€ state = "MOVING"
â”‚  â”‚  â”‚  â”œâ”€ state_confidence = 0.5
â”‚  â”‚  â”‚  â””â”€ no_move_frames = 0
â”‚  â”‚  â”‚
â”‚  â”‚  â”œâ”€ elif state == "MOVING":
â”‚  â”‚  â”‚  â”œâ”€ state_confidence = min(1.0, state_confidence + 0.1)
â”‚  â”‚  â”‚  â””â”€ no_move_frames = 0
â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€ elif state == "STOPPED":
â”‚  â”‚     â”œâ”€ state = "MOVING"
â”‚  â”‚     â”œâ”€ state_confidence = 0.5
â”‚  â”‚     â””â”€ no_move_frames = 0
â”‚  â”‚
â”‚  â””â”€ else:  [æ— ç§»åŠ¨è¢«æ£€æµ‹]
â”‚     â”œâ”€ no_move_frames++
â”‚     â”œâ”€ if state == "MOVING" AND no_move_frames >= 3:
â”‚     â”‚  â””â”€ state = "STOPPED"
â”‚     â”‚
â”‚     â”œâ”€ if state == "STOPPED" AND no_move_frames >= 5:
â”‚     â”‚  â””â”€ state = "IDLE"
â”‚     â”‚
â”‚     â””â”€ smooth_dx = 0, smooth_dy = 0
â”‚
â””â”€ è¿”å›ç»“æœ
   â”œâ”€ return (has_moved, smooth_dx, smooth_dy, smooth_response, state)
   â””â”€ save self.smooth_dx/dy/response for next iteration
```

---

## ğŸ“Š stitch() è¯¦ç»†æµç¨‹

```
è¾“å…¥: minimap(æ–°å¸§), last_minimap(æ—§å¸§), dx, dy, confidence
â”‚
â”œâ”€ [è·¯å¾„1] é«˜ç½®ä¿¡åº¦ (confidence > 0.85) - å¢é‡æ‹¼æ¥
â”‚  â”‚
â”‚  â”œâ”€ ã€è®¡ç®—æ°´å¹³æ–°å¢åŒºåŸŸã€‘
â”‚  â”‚  â”œâ”€ if dx > 0 (å‘å³ç§»åŠ¨):
â”‚  â”‚  â”‚  â”œâ”€ ä»å°åœ°å›¾å·¦è¾¹å¤åˆ¶æ–°å†…å®¹åˆ°ç”»å¸ƒå·¦è¾¹
â”‚  â”‚  â”‚  â”œâ”€ new_left = 0
â”‚  â”‚  â”‚  â”œâ”€ new_right = min(|dx|, w)
â”‚  â”‚  â”‚  â””â”€ canvas_left = canvas_x
â”‚  â”‚  â”‚
â”‚  â”‚  â”œâ”€ elif dx < 0 (å‘å·¦ç§»åŠ¨):
â”‚  â”‚  â”‚  â”œâ”€ ä»å°åœ°å›¾å³è¾¹å¤åˆ¶æ–°å†…å®¹åˆ°ç”»å¸ƒå³è¾¹
â”‚  â”‚  â”‚  â”œâ”€ new_left = max(0, w + dx)
â”‚  â”‚  â”‚  â”œâ”€ new_right = w
â”‚  â”‚  â”‚  â””â”€ canvas_left = canvas_x + w + dx
â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€ else (æ— æ°´å¹³ç§»åŠ¨):
â”‚  â”‚     â”œâ”€ new_left = 0
â”‚  â”‚     â”œâ”€ new_right = w
â”‚  â”‚     â””â”€ canvas_left = canvas_x
â”‚  â”‚
â”‚  â”œâ”€ ã€è®¡ç®—ç«–ç›´æ–°å¢åŒºåŸŸã€‘ (ç±»ä¼¼é€»è¾‘)
â”‚  â”‚  â”œâ”€ if dy > 0: ä»ä¸Šè¾¹å¤åˆ¶
â”‚  â”‚  â”œâ”€ elif dy < 0: ä»ä¸‹è¾¹å¤åˆ¶
â”‚  â”‚  â””â”€ else: å…¨éƒ¨å¤åˆ¶
â”‚  â”‚
â”‚  â”œâ”€ ã€æå–æ–°å¢åŒºåŸŸã€‘
â”‚  â”‚  â”œâ”€ new_region = minimap[new_top:new_bottom, new_left:new_right]
â”‚  â”‚  â”œâ”€ canvas_h = new_bottom - new_top
â”‚  â”‚  â””â”€ canvas_w = new_right - new_left
â”‚  â”‚
â”‚  â”œâ”€ ã€è¾¹ç•Œæ£€æŸ¥ã€‘
â”‚  â”‚  â”œâ”€ if all canvas coordinates within bounds:
â”‚  â”‚  â”‚
â”‚  â”‚  â”œâ”€ ã€èåˆå¤„ç†ã€‘
â”‚  â”‚  â”‚  â”œâ”€ if (dx != 0 OR dy != 0) AND confidence > 0.75:
â”‚  â”‚  â”‚  â”‚  â””â”€ blend_region = _blend_region()
â”‚  â”‚  â”‚  â”‚     â”œâ”€ è®¡ç®—è·ç¦»è¾¹ç•Œçš„æƒé‡
â”‚  â”‚  â”‚  â”‚     â”œâ”€ weight_x/y = é«˜æ–¯åˆ†å¸ƒ (è¾¹ç•Œä½, å†…éƒ¨é«˜)
â”‚  â”‚  â”‚  â”‚     â”œâ”€ æ ¹æ®confidenceè°ƒæ•´æƒé‡å¼ºåº¦
â”‚  â”‚  â”‚  â”‚     â””â”€ blended = new * weight + old * (1-weight)
â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€ canvas[canvas_top:bottom, canvas_left:right] = blended
â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€ else: ç›´æ¥è¦†ç›–
â”‚  â”‚     â””â”€ canvas[canvas_top:bottom, canvas_left:right] = new_region
â”‚  â”‚
â”‚  â””â”€ return True
â”‚
â”œâ”€ [è·¯å¾„2] ä½ç½®ä¿¡åº¦ (confidence â‰¤ 0.85) - ç‰¹å¾åŒ¹é…å¯¹é½
â”‚  â”‚
â”‚  â”œâ”€ ã€ORBç‰¹å¾æ£€æµ‹ã€‘
â”‚  â”‚  â”œâ”€ kp1, des1 = orb.detectAndCompute(last_minimap)
â”‚  â”‚  â”œâ”€ kp2, des2 = orb.detectAndCompute(minimap)
â”‚  â”‚  â”‚
â”‚  â”‚  â”œâ”€ if features not enough (< 4 keypoints):
â”‚  â”‚  â”‚  â””â”€ return _simple_stitch(minimap, dx, dy)
â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€ else: ç»§ç»­åŒ¹é…
â”‚  â”‚
â”‚  â”œâ”€ ã€ç‰¹å¾åŒ¹é…ã€‘
â”‚  â”‚  â”œâ”€ matches = bf_matcher.knnMatch(des1, des2, k=2)
â”‚  â”‚  â”œâ”€ for each match_pair in matches:
â”‚  â”‚  â”‚  â”œâ”€ if m.distance < 0.75 * n.distance:  [Lowe's ratio test]
â”‚  â”‚  â”‚  â”‚  â””â”€ good_matches.append(m)
â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€ else: è¿‡æ»¤æ‰ä¸å¯é çš„åŒ¹é…
â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€ if good_matches < 4:
â”‚  â”‚     â””â”€ return _simple_stitch(minimap, dx, dy)
â”‚  â”‚
â”‚  â”œâ”€ ã€RANSACä»¿å°„å˜æ¢ä¼°è®¡ã€‘
â”‚  â”‚  â”œâ”€ pts1 = æ—§å¸§ç‰¹å¾ç‚¹åæ ‡
â”‚  â”‚  â”œâ”€ pts2 = æ–°å¸§ç‰¹å¾ç‚¹åæ ‡
â”‚  â”‚  â”œâ”€ matrix, mask = estimateAffinePartial2D(pts1, pts2, RANSAC)
â”‚  â”‚  â”‚
â”‚  â”‚  â”œâ”€ if matrix is None:
â”‚  â”‚  â”‚  â””â”€ return _simple_stitch(minimap, dx, dy)
â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€ else: è®¡ç®—æ ¡æ­£ä½ç§»
â”‚  â”‚     â”œâ”€ corrected_dx = matrix[0, 2]
â”‚  â”‚     â”œâ”€ corrected_dy = matrix[1, 2]
â”‚  â”‚     â””â”€ return _simple_stitch(minimap, corrected_dx, corrected_dy)
â”‚  â”‚
â”‚  â””â”€ exception: return _simple_stitch(minimap, dx, dy)
â”‚
â””â”€ return success_flag
```

---

## ğŸ”„ çŠ¶æ€æœºè½¬ç§»å›¾

```
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚  åˆå§‹åŒ–: state = "IDLE"              â”‚
                     â”‚  åˆå§‹åŒ–: no_move_frames = 0           â”‚
                     â”‚  åˆå§‹åŒ–: state_confidence = 0         â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚      ğŸ“ IDLE çŠ¶æ€          â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚ ç‰¹ç‚¹ï¼šä¸¥æ ¼è¦æ±‚             â”‚
                    â”‚ response > 0.80            â”‚
                    â”‚ mean_diff +1.5*std_dev    â”‚
                    â”‚ ç”¨é€”ï¼šé˜²æ­¢é™æ­¢æ—¶è¯¯è§¦       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â”‚ âœ… æ£€æµ‹åˆ°çœŸå®ç§»åŠ¨
                                  â”‚ (4ä¸ªæ¡ä»¶å…¨æ»¡è¶³)
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   ğŸ”„ MOVING çŠ¶æ€           â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚ ç‰¹ç‚¹ï¼šå®½æ¾è¦æ±‚             â”‚
                    â”‚ response > 0.60            â”‚
                    â”‚ mean_diff +0.8*std_dev    â”‚
                    â”‚ ç”¨é€”ï¼šå¿«é€Ÿå“åº”ç§»åŠ¨         â”‚
                    â”‚                            â”‚
                    â”‚ state_confidenceâ†‘ æ¯ç§»åŠ¨   â”‚
                    â”‚ no_move_frames = 0         â”‚
                    â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜
                       â”‚                      â”‚
                       â”‚ âŒ æ— ç§»åŠ¨3å¸§+       â”‚ âœ… æœ‰ç§»åŠ¨
                       â”‚                      â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
            â”‚  â¸ï¸ STOPPED çŠ¶æ€     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
            â”‚ ç‰¹ç‚¹ï¼šå¹³è¡¡è¦æ±‚       â”‚
            â”‚ response > 0.70      â”‚
            â”‚ mean_diff +1.2*std..â”‚
            â”‚ ç”¨é€”ï¼šéªŒè¯æ˜¯å¦åœæ­¢   â”‚
            â”‚                      â”‚
            â”‚ no_move_frames=3..  â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
                       â”‚       â”‚
                       â”‚       â”‚ âœ… æœ‰ç§»åŠ¨
                       â”‚       â”‚
        âŒ æ— ç§»åŠ¨5å¸§+  â”‚       â””â”€â”€â”€â”€â”€â†’ MOVING
                       â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   ğŸ‘ˆ å›åˆ° IDLE       â”‚
            â”‚   no_move_frames=0  â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


ã€çŠ¶æ€ç‰¹å¾å¯¹æ¯”è¡¨ã€‘

çŠ¶æ€    â”‚ responseé˜ˆå€¼ â”‚ mean_diffå€æ•° â”‚ è½¬ç§»æ¡ä»¶        â”‚ ç”¨é€”
â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
IDLE    â”‚ 0.80        â”‚ 1.5x std     â”‚ ç§»åŠ¨â†’MOVING    â”‚ é˜²æ­¢è¯¯è§¦
MOVING  â”‚ 0.60        â”‚ 0.8x std     â”‚ 3å¸§æ— ç§»â†’STOPPEDâ”‚ å¿«é€Ÿå“åº”
STOPPED â”‚ 0.70        â”‚ 1.2x std     â”‚ 5å¸§æ— ç§»â†’IDLE   â”‚ éªŒè¯åœæ­¢
        â”‚             â”‚              â”‚ æœ‰ç§»â†’MOVING    â”‚
```

---

## ğŸŒŠ Kalmanæ»¤æ³¢çš„æ•ˆæœ

```
ã€åŸå§‹ä½ç§»ä¿¡å· (å¸¦æŠ–åŠ¨)ã€‘
ä½ç§»å€¼: [12.1, 12.3, 11.9, 12.2, 12.0, 12.4, 12.1]
é—®é¢˜ï¼šé¢‘ç¹ä¸Šä¸‹è·³åŠ¨0.2-0.4åƒç´ 


ã€Kalmanæ»¤æ³¢å (å¹³æ»‘)ã€‘
smooth = 0.7 * prev + 0.3 * new

è®¡ç®—è¿‡ç¨‹ï¼š
  Frame 0: smooth = 12.1 (åˆå§‹)
  Frame 1: smooth = 0.7*12.1 + 0.3*12.3 = 12.13  â† å¹³æ»‘
  Frame 2: smooth = 0.7*12.13 + 0.3*11.9 = 12.05 â† å¹³æ»‘
  Frame 3: smooth = 0.7*12.05 + 0.3*12.2 = 12.10 â† å¹³æ»‘
  Frame 4: smooth = 0.7*12.10 + 0.3*12.0 = 12.07 â† å¹³æ»‘

å¹³æ»‘å€¼: [12.1, 12.13, 12.05, 12.10, 12.07, 12.15, 12.10]
ç‰¹ç‚¹ï¼šæŠ–åŠ¨å®Œå…¨æ¶ˆé™¤ï¼Œæ ¸å¿ƒè¶‹åŠ¿ä¿ç•™


ã€æƒé‡è°ƒæ•´çš„å½±å“ã€‘
æƒé‡æ¯”ä¾‹        â”‚ ç‰¹æ€§
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
0.8 * prev      â”‚ è¿‡åº¦å¹³æ»‘ï¼Œååº”æ…¢
0.7 * prev      â”‚ [é»˜è®¤] æœ€ä¼˜å¹³è¡¡
0.6 * prev      â”‚ å“åº”æ›´å¿«ï¼Œä½†æŠ–åŠ¨ä»å­˜
0.5 * prev      â”‚ åŸºæœ¬æ— å¹³æ»‘ï¼Œæ¥è¿‘åŸå§‹å€¼
```

---

## ğŸ“ˆ è‡ªé€‚åº”é˜ˆå€¼è®¡ç®—

```
ã€åŸç†ã€‘
adaptive_threshold = baseline + k Ã— std_dev

baseline = æœ€è¿‘30å¸§mean_diffçš„å¹³å‡å€¼  (å…‰ç…§åŸºå‡†)
std_dev = æœ€è¿‘30å¸§mean_diffçš„æ ‡å‡†å·®   (ç¯å¢ƒå™ªå£°)
k = çŠ¶æ€ç›¸å…³ç³»æ•°                       (æ ¹æ®stateè°ƒæ•´)


ã€è®¡ç®—ç¤ºä¾‹ã€‘

å‡è®¾æœ€è¿‘30å¸§çš„mean_diffå€¼ï¼š
[2.1, 2.3, 2.2, 2.4, 2.1, 2.5, 2.2, 2.3, 2.4, 2.2,
 2.3, 2.1, 2.4, 2.2, 2.3, 2.1, 2.2, 2.3, 2.4, 2.1,
 2.2, 2.3, 2.5, 2.2, 2.3, 2.1, 2.4, 2.2, 2.3, 2.2]

baseline = mean(...) = 2.25
std_dev = std(...) = 0.12


ã€ä¸åŒçŠ¶æ€ä¸‹çš„é˜ˆå€¼ã€‘

çŠ¶æ€      â”‚ å…¬å¼                    â”‚ è®¡ç®—ç»“æœ  â”‚ è¯´æ˜
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
IDLE      â”‚ 2.25 + 1.5 Ã— 0.12     â”‚ 2.43     â”‚ ä¸¥æ ¼ï¼Œ3å€stdä»¥ä¸Šæ‰ç®—
MOVING    â”‚ 2.25 + 0.8 Ã— 0.12     â”‚ 2.35     â”‚ å®½æ¾ï¼Œ1.5å€stdä»¥ä¸Š
STOPPED   â”‚ 2.25 + 1.2 Ã— 0.12     â”‚ 2.39     â”‚ å¹³è¡¡ï¼Œ2.5å€stdä»¥ä¸Š


ã€ä¼˜åŠ¿ã€‘

å¯¹æ¯”ç¡¬ç¼–ç é˜ˆå€¼(å›ºå®š3.0):
  â”œâ”€ é«˜å…‰ç…§å˜åŒ–æ—¶ï¼šbaselineä¸Šå‡ï¼Œé˜ˆå€¼è·Ÿéšä¸Šå‡
  â”œâ”€ ä½å…‰ç…§å˜åŒ–æ—¶ï¼šbaselineä¸‹é™ï¼Œé˜ˆå€¼è·Ÿéšä¸‹é™
  â”œâ”€ UIé—ªåŠ¨å¤šæ—¶ï¼šstd_devä¸Šå‡ï¼ŒIDLEæ—¶é˜ˆå€¼ä¸Šå‡é˜²æ­¢è¯¯è§¦
  â””â”€ UIé—ªåŠ¨å°‘æ—¶ï¼šstd_devä¸‹é™ï¼ŒMOVINGæ—¶é˜ˆå€¼ä¸‹é™ä¾¿äºæ£€æµ‹

ç»“æœï¼šå®Œå…¨è‡ªé€‚åº”ç¯å¢ƒï¼Œæ— éœ€æ‰‹åŠ¨è°ƒæ•´
```

---

## ğŸ¯ æ¸å˜èåˆçš„æƒé‡åˆ†å¸ƒ

```
ã€æ— èåˆ (ç›´æ¥è¦†ç›–)ã€‘
â”œâ”€ æ–°å¸§åƒç´  100%
â”œâ”€ æ—§å¸§åƒç´  0%
â””â”€ é—®é¢˜ï¼šè¾¹ç•Œè‰²å·®æ˜æ˜¾ âŒ


ã€é«˜æ–¯æƒé‡èåˆã€‘

æ°´å¹³æ–¹å‘çš„æƒé‡åˆ†å¸ƒï¼ˆdx>0å‘å³ç§»åŠ¨ï¼‰ï¼š
  è¾¹ç•Œ        ä¸­é—´        è¾¹ç•Œ
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ 0.2  0.4  0.6  0.8  1.0â”‚  â† è·ç¦»å³è¾¹ç•Œè¶Šè¿œï¼Œæƒé‡è¶Šé«˜
  â”‚ æ–°å¸§  20%  40%  60%  80%â”‚100% (æ–°å¸§)
  â”‚ æ—§å¸§  80%  60%  40%  20%â”‚0%  (æ—§å¸§)


ç«–ç›´æ–¹å‘ç±»ä¼¼ï¼š
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¤ (if dy>0)
  â”‚ 0.2    â”‚
  â”‚ 0.4    â”‚
  â”‚ 0.6    â”‚
  â”‚ 0.8    â”‚
  â”‚ 1.0    â”‚ â† è·ç¦»ä¸Šè¾¹ç•Œè¶Šè¿œï¼Œæƒé‡è¶Šé«˜


ã€äºŒç»´é«˜æ–¯æƒé‡ã€‘(dx && dyéƒ½ä¸ä¸º0)

           â”‚ å·¦è¾¹ç•Œ  ä¸­é—´  å³è¾¹ç•Œ
    â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ä¸Šè¾¹ç•Œ â”‚ 0.04  0.20  0.16
    ä¸­é—´   â”‚ 0.20  1.00  0.20
    ä¸‹è¾¹ç•Œ â”‚ 0.16  0.20  0.04

ç‰¹ç‚¹ï¼š
  â”œâ”€ å››ä¸ªè§’è½æƒé‡æœ€ä½ï¼ˆ0.04-0.16ï¼‰
  â”œâ”€ ä¸­å¿ƒæƒé‡æœ€é«˜ï¼ˆ1.0ï¼‰
  â””â”€ è¾¹ç•Œå¹³æ»‘è¿‡æ¸¡ï¼Œæ— çªå…€è‰²å·®çº¿


ã€confidenceçš„å½±å“ã€‘

weight_final = (weight_map) Ã— confidence + (1 - confidence) Ã— 0.5

confidence=0.95ï¼ˆé«˜ï¼‰ï¼š
  â†’ weight_final â‰ˆ weight_map   (ä¿æŒé«˜æ–¯åˆ†å¸ƒç‰¹æ€§)

confidence=0.70ï¼ˆä¸­ï¼‰ï¼š
  â†’ weight_final â‰ˆ 0.5~weight_map (èåˆæ¯”ä¾‹å‡å¼±)

confidence=0.50ï¼ˆä½ï¼‰ï¼š
  â†’ weight_final â‰ˆ 0.5 (åŒæ–¹å„50%)


ã€å®é™…è§†è§‰æ•ˆæœã€‘

æ‹¼æ¥å¤„ç«–ç›´ç¼çº¿ï¼ˆæ¦‚å¿µå›¾ï¼‰ï¼š

æ— èåˆ:
  æ—§å¸§    â”‚æ–°å¸§
  XXXXXX â”‚YYYYYY  â† è‰²å·®çº¿æ˜æ˜¾
  
æ¸å˜èåˆ:
  æ—§å¸§    â”‚èåˆè¿‡æ¸¡â”‚æ–°å¸§
  XXXXXX â–³â–³YYYYYY  â† å¹³æ»‘è¿‡æ¸¡
```

---

## âš™ï¸ ORBç‰¹å¾åŒ¹é…æµç¨‹

```
ã€è¾“å…¥ã€‘
â”œâ”€ æ—§å¸§ (last_minimap)
â””â”€ æ–°å¸§ (minimap)


ã€ç¬¬ä¸€æ­¥ã€‘ORBç‰¹å¾æ£€æµ‹
â”œâ”€ kp1, des1 = orb.detectAndCompute(last_minimap)
â”‚  â”œâ”€ æ£€æµ‹500ä¸ªå…³é”®ç‚¹ (nfeatures=500)
â”‚  â””â”€ è®¡ç®—æ¯ä¸ªå…³é”®ç‚¹çš„æè¿°ç¬¦
â”‚
â”œâ”€ kp2, des2 = orb.detectAndCompute(minimap)
â”‚  â”œâ”€ æ£€æµ‹500ä¸ªå…³é”®ç‚¹
â”‚  â””â”€ è®¡ç®—æ¯ä¸ªå…³é”®ç‚¹çš„æè¿°ç¬¦
â”‚
â””â”€ ç‰¹å¾ä¸è¶³æ£€æŸ¥
   â”œâ”€ if len(kp1) < 4 or len(kp2) < 4:
   â”‚  â””â”€ return _simple_stitch()  âœ— ç‰¹å¾å¤ªå°‘ï¼Œæ”¾å¼ƒç‰¹å¾åŒ¹é…
   â””â”€ else: ç»§ç»­


ã€ç¬¬äºŒæ­¥ã€‘ç‰¹å¾åŒ¹é… (BF Matcher)
â”œâ”€ matches = bf_matcher.knnMatch(des1, des2, k=2)
â”‚  â””â”€ ä¸ºæ¯ä¸ªæ—§å¸§ç‰¹å¾æ‰¾åˆ°æœ€ç›¸ä¼¼çš„2ä¸ªæ–°å¸§ç‰¹å¾
â”‚
â”œâ”€ Lowe's Ratio Test (è¿‡æ»¤)
â”‚  for m, n in matches:
â”‚     if m.distance < 0.75 * n.distance:
â”‚        good_matches.append(m)
â”‚
â”‚  è¯´æ˜ï¼š
â”‚  â””â”€ æœ€ä½³åŒ¹é…è·ç¦» < 0.75 Ã— æ¬¡ä½³åŒ¹é…è·ç¦»
â”‚     è¯´æ˜ç‰¹å¾æ˜ç¡®å¯¹åº”ï¼Œå€¼å¾—ä¿¡ä»»
â”‚
â””â”€ åŒ¹é…è´¨é‡æ£€æŸ¥
   â”œâ”€ if len(good_matches) < 4:
   â”‚  â””â”€ return _simple_stitch()  âœ— åŒ¹é…ç‚¹å¤ªå°‘
   â””â”€ else: ç»§ç»­


ã€ç¬¬ä¸‰æ­¥ã€‘RANSACä»¿å°„å˜æ¢ä¼°è®¡
â”œâ”€ æå–åŒ¹é…ç‚¹å¯¹çš„åæ ‡
â”‚  â”œâ”€ pts1 = [kp1[m.queryIdx].pt for m in good_matches]  â† æ—§å¸§åæ ‡
â”‚  â””â”€ pts2 = [kp2[m.trainIdx].pt for m in good_matches]  â† æ–°å¸§åæ ‡
â”‚
â”œâ”€ RANSACç®—æ³•
â”‚  â”œâ”€ éšæœºé€‰æ‹©3å¯¹ç‚¹ï¼Œæ‹Ÿåˆä»¿å°„å˜æ¢çŸ©é˜µ
â”‚  â”œâ”€ ç”¨è¯¥çŸ©é˜µæ£€éªŒå…¶ä»–ç‚¹
â”‚  â”œâ”€ è®¡æ•°æœ‰å¤šå°‘ç‚¹ç¬¦åˆè¿™ä¸ªçŸ©é˜µ
â”‚  â”œâ”€ é‡å¤å¤šæ¬¡ï¼Œé€‰æ‹©æ”¯æŒç‚¹æœ€å¤šçš„çŸ©é˜µ
â”‚  â””â”€ [ç»“æœ] æ¶ˆé™¤å¼‚å¸¸åŒ¹é…ç‚¹çš„å½±å“
â”‚
â”œâ”€ matrix, mask = estimateAffinePartial2D(pts1, pts2, RANSAC)
â”‚  â”œâ”€ matrix: ä»¿å°„å˜æ¢çŸ©é˜µ [[a, b, tx], [c, d, ty]]
â”‚  â”œâ”€ mask: å“ªäº›ç‚¹è¢«è®¤ä¸ºæ˜¯å†…ç‚¹ (vs å¤–ç‚¹)
â”‚  â””â”€ å¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„å…±è¯†ï¼Œè¿”å›None
â”‚
â””â”€ æ ¡æ­£ä½ç§»
   â”œâ”€ if matrix is None:
   â”‚  â””â”€ return _simple_stitch()  âœ— RANSACå¤±è´¥
   â””â”€ else:
      â”œâ”€ corrected_dx = matrix[0, 2]  â† ä»ä»¿å°„çŸ©é˜µæå–dx
      â”œâ”€ corrected_dy = matrix[1, 2]  â† ä»ä»¿å°„çŸ©é˜µæå–dy
      â””â”€ return _simple_stitch(minimap, corrected_dx, corrected_dy)


ã€è¾“å‡ºã€‘
â””â”€ ä½¿ç”¨æ ¡æ­£åçš„ä½ç§»è¿›è¡Œæ‹¼æ¥ï¼Œç²¾åº¦æ›´é«˜ âœ“


ã€ä¾‹å­ã€‘

æ—§å¸§ç‰¹å¾: [(100, 200), (150, 250), (200, 300), ...]
æ–°å¸§å¯¹åº”ç‰¹å¾: [(112, 195), (162, 245), (212, 295), ...]

ä½ç§»ä¼°è®¡:
  dx â‰ˆ (112-100 + 162-150 + ...) / n â‰ˆ 12.3
  dy â‰ˆ (195-200 + 245-250 + ...) / n â‰ˆ -5.1

RANSACçš„ä½œç”¨:
  â”œâ”€ å¦‚æœæŸä¸ªåŒ¹é…æ˜æ˜¾åç¦»è¶‹åŠ¿ï¼ˆæ¯”å¦‚å®é™…æ˜¯(205, 290)ï¼‰
  â”œâ”€ å®ƒä¼šè¢«æ ‡è®°ä¸ºå¤–ç‚¹ (outlier)
  â””â”€ è®¡ç®—æ—¶è¢«å¿½ç•¥ï¼Œä¸å½±å“æœ€ç»ˆç»“æœ
```

---

## ğŸ“ å…³é”®æ•°æ®ç»“æ„

```python
# å†å²æ•°æ®ï¼ˆç”¨äºè‡ªé€‚åº”è®¡ç®—ï¼‰
mean_diff_history: deque[float]
  â”œâ”€ æœ€å¤§é•¿åº¦ï¼š30å¸§
  â”œâ”€ ç”¨é€”ï¼šè®¡ç®—è‡ªé€‚åº”é˜ˆå€¼çš„baselineå’Œstd_dev
  â””â”€ æ›´æ–°é¢‘ç‡ï¼šæ¯å¸§ä¸€æ¬¡

movement_history: deque[tuple(float, float, float)]
  â”œâ”€ å…ƒç´ ï¼š(smooth_dx, smooth_dy, smooth_response)
  â”œâ”€ æœ€å¤§é•¿åº¦ï¼š5å¸§
  â”œâ”€ ç”¨é€”ï¼šdebugå’Œæœªæ¥çš„è‡ªå­¦ä¹ ä¼˜åŒ–
  â””â”€ æ›´æ–°é¢‘ç‡ï¼šä»…åœ¨has_movedæ—¶æ›´æ–°


# Kalmanæ»¤æ³¢çŠ¶æ€
smooth_dx: float          # å¹³æ»‘åçš„xæ–¹å‘ä½ç§»
smooth_dy: float          # å¹³æ»‘åçš„yæ–¹å‘ä½ç§»
smooth_response: float    # å¹³æ»‘åçš„ç½®ä¿¡åº¦

update_rule: new = 0.7 * prev + 0.3 * current


# çŠ¶æ€æœºçŠ¶æ€
state: str                # "IDLE" | "MOVING" | "STOPPED"
state_confidence: float   # [0, 1] çŠ¶æ€ç¡®è®¤åº¦
no_move_frames: int       # è¿ç»­æ— ç§»åŠ¨çš„å¸§æ•°

è½¬ç§»è§„åˆ™è§çŠ¶æ€æœºè½¬ç§»å›¾


# ç”»å¸ƒç®¡ç†
canvas: ndarray[H, W, 3]  # 3000Ã—3000 RGBå›¾åƒ
canvas_x: int             # å½“å‰å°åœ°å›¾åœ¨ç”»å¸ƒä¸­çš„xåæ ‡
canvas_y: int             # å½“å‰å°åœ°å›¾åœ¨ç”»å¸ƒä¸­çš„yåæ ‡


# ç‰¹å¾æ£€æµ‹å™¨
orb: ORB_create()         # ORBç‰¹å¾æ£€æµ‹å™¨ (500ç‰¹å¾ç‚¹)
bf_matcher: BFMatcher()   # æš´åŠ›ç‰¹å¾åŒ¹é…å™¨ (HAMMINGè·ç¦»)
```

---

## ğŸ”— å‡½æ•°è°ƒç”¨å…³ç³»

```
main()
â”œâ”€ SmartMinimapStitcher.__init__()
â”‚  â”œâ”€ åˆ›å»ºJy_screen()å¹¶ç»‘å®šçª—å£
â”‚  â”œâ”€ åˆå§‹åŒ–å„ç§çŠ¶æ€å˜é‡
â”‚  â””â”€ åˆ›å»ºORBå’ŒBFMatcher
â”‚
â””â”€ stitcher.run()  â† ä¸»å¾ªç¯
   â”œâ”€ [åˆå§‹åŒ–] capture_minimap() â†’ first_frame
   â”‚
   â””â”€ while True:  â† ä¸»å¾ªç¯
      â”œâ”€ capture_minimap() â†’ minimap_new
      â”‚
      â”œâ”€ detect_movement(last_minimap, minimap_new)
      â”‚  â”œâ”€ è®¡ç®—mean_diff
      â”‚  â”œâ”€ è®¡ç®—è‡ªé€‚åº”é˜ˆå€¼
      â”‚  â”œâ”€ ç›¸ä½ç›¸å…³
      â”‚  â”œâ”€ Kalmanæ»¤æ³¢
      â”‚  â”œâ”€ å¤šæ¡ä»¶éªŒè¯
      â”‚  â””â”€ çŠ¶æ€æœºè½¬ç§»
      â”‚  â””â”€ return (has_moved, dx, dy, response, state)
      â”‚
      â”œâ”€ if has_moved:
      â”‚  â”œâ”€ stitch(minimap_new, last_minimap, dx, dy, response)
      â”‚  â”‚  â”œâ”€ if confidence > 0.85:  [è·¯å¾„1 å¢é‡æ‹¼æ¥]
      â”‚  â”‚  â”‚  â”œâ”€ è®¡ç®—æ–°å¢åŒºåŸŸåæ ‡
      â”‚  â”‚  â”‚  â”œâ”€ if éœ€è¦èåˆ:
      â”‚  â”‚  â”‚  â”‚  â””â”€ _blend_region()
      â”‚  â”‚  â”‚  â”‚     â”œâ”€ è®¡ç®—é«˜æ–¯æƒé‡
      â”‚  â”‚  â”‚  â”‚     â”œâ”€ èåˆåƒç´ 
      â”‚  â”‚  â”‚  â”‚     â””â”€ return blended_region
      â”‚  â”‚  â”‚  â”‚
      â”‚  â”‚  â”‚  â””â”€ å¤åˆ¶åˆ°ç”»å¸ƒ
      â”‚  â”‚  â”‚
      â”‚  â”‚  â””â”€ else:  [è·¯å¾„2 ç‰¹å¾åŒ¹é…]
      â”‚  â”‚     â”œâ”€ orb.detectAndCompute() x2
      â”‚  â”‚     â”œâ”€ bf_matcher.knnMatch()
      â”‚  â”‚     â”œâ”€ Lowe's ratio test
      â”‚  â”‚     â”œâ”€ estimateAffinePartial2D()
      â”‚  â”‚     â”œâ”€ _simple_stitch(corrected_dx, dy)
      â”‚  â”‚     â”‚  â”œâ”€ æ›´æ–°canvas_x/y
      â”‚  â”‚     â”‚  â””â”€ å¤åˆ¶åˆ°ç”»å¸ƒ
      â”‚  â”‚     â”‚
      â”‚  â”‚     â””â”€ return success
      â”‚  â”‚
      â”‚  â””â”€ update last_minimap
      â”‚
      â”œâ”€ cv2.imshow() â†’ display
      â”œâ”€ cv2.waitKey() â†’ handle input
      â””â”€ time.sleep(0.05)
   
   â”œâ”€ ä¿å­˜ final_smart_stitch.png
   â”œâ”€ è£å‰ªå¹¶ä¿å­˜ final_smart_stitch_cropped.png
   â””â”€ æ‰“å°ç»Ÿè®¡ä¿¡æ¯
```


